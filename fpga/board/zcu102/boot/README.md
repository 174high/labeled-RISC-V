
# Preparing BOOT.BIN

Refer to www.wiki.xilinx.com/Fetch+Sources for more information.

## NOTICE

*Avoid inserting JTAG while booting from SD card. It seems that there are some conflicts between JTAG and SD card.*

## Build fsbl.elf - First Step Boot Loader

1. Vivado -> File -> Export -> Export Hardware

Then run `hsi`
```
hsi -nojournal -nolog -source gen-fsbl.tcl -tclargs [path to hdf file]
```
where hdf file is generated by the previous step.

*Note:* fsbl.elf should be regenerated after the configuration of ZYNQMP changes.

## Build pmufw.elf - Platform Monitor Unit Firmware

### Using SDK

1. Vivado -> File -> Launch SDK
1. SDK -> File -> New -> Application Project
  * Project name: `pmufw`
  * OS Platform: `standlone`
  * Hardware Platform: choose the current design platform, instead of pre-defined platforms
  * Proecssor: `psu_pmu_0`
  * Next -> Zynq MP PMU -> Finish
1. Find `pmufw.elf` under `xxx/xxx.sdk/pmufw/Debug/`, where `xxx` is the vivado project name

### Using hsi

*Note:* Should use SDK. Using hsi with Vivado 2017.3 will get a linking error. See [here](https://forums.xilinx.com/t5/Embedded-Processor-System-Design/2017-3-PMUFW-compilation-failure-on-zynqmp-UltraScale-RAM/td-p/802155).

```
hsi -nojournal -nolog -source gen-pmufw.tcl -tclargs [path to hdf file]
```
where hdf file is generated by `Export Hardware` in the previous step when building fsbl.elf.

## Build bl31.elf - Arm Trusted Firmware

```
git clone https://github.com/xilinx/arm-trusted-firmware
cd arm-trusted-firmware
make PLAT=zynqmp RESET_TO_BL31=1 CROSS_COMPILE=aarch64-none-elf-
```
Find `bl31.elf` under `arm-trusted-firmware/build/zynqmp/release/bl31/`.

To clean, run
```
make PLAT=zynqmp RESET_TO_BL31=1 clean
```

## Build u-boot

```
git clone https://github.com/xilinx/u-boot-xlnx
cd u-boot-xlnx
make xilinx_zynqmp_zcu102_rev1_0_defconfig  # can be found under u-boot-xlnx/configs/
make CROSS_COMPILE=aarch64-linux-gnu-
```
Find `u-boot` under `u-boot-xlnx/`.

### Some useful build-in commands under u-boot

* `load mmc 0:auto <addr> <file>` - load `file` in SD card into memory `addr`
* `fatls mmc 0 <path>` - list files under `path` in SD card
* `fatwrite mmc 0 <addr> <file> <byte_in_hex>` - write `file` of size `byte_in_hex` from memory `addr` into SD card
* `fpga loadb 0 <addr> <byte_in_hex>` - download bitstream of size `byte_in_hex` from memory `addr`

### Some useful customized commands

* set IP address and TFTP server address
```
setenv ipaddr 10.30.6.61
setenv serverip 10.30.6.123
```

* download FPGA, get linux kernel image and DTB file by TFTP, then boot the kernel
```
"netboot=tftpboot 0x100000 fpga.bit && fpga loadb 0 $fileaddr $filesize && " \
"tftpboot $kernel_addr Image && tftpboot $fdt_addr system.dtb && booti $kernel_addr - $fdt_addr \0"
```

* download file by TFTP to the boot partition (`mmcblk0p1`) of SD card
```
// should set $filename first
"download_sd=tftpboot 0x100000 $filename && fatwrite mmc 0 $fileaddr $filename $filesize\0"
```

* update the boot partition (`mmcblk0p1`) of SD card (`BOOT.BIN` and `system.dtb`) by TFTP
```
"update_sdboot=setenv filename BOOT.BIN && run download_sd && " \
"setenv filename system.dtb && run download_sd\0"
```

## Build BOOT.BIN

1. Put `fsbl.elf`, `pmufw.elf`, `bl31.elf` and `u-boot` generated by previous steps under `build/` directory
1. (Optional) If you want to download the bitstream during fsbl, also put the bitstream under `build/` directory, and uncomment the description about bitstream in `gen-bootbin.sh`
1. run `bash gen-bootbin.sh`, `BOOT.BIN` will be generated under `build/`

## Build linux kernel

```
git clone https://github.com/xilinx/linux-xlnx
cd linux-xlnx
git checkout f1b1e077d641fc83b54c1b8f168cbb58044fbd4e  # this is the release version of 2017.03
make ARCH=arm64 xilinx_zynqmp_defconfig # can be found under linux-xlnx/arch/arm64/configs/
make ARCH=arm64 menuconfig
  General setup -> Cross-compiler tool prefix: `aarch64-linux-gnu-`
  General setup -> unchoose `Initial RAM filesystem and RAM disk (initramfs/initrd) support`
  Boot options -> Default kernel command string: `console=ttyPS0,115200 root=/dev/mmcblk0p2 rootfstype=ext4 rw earlyprintk earlycon clk_ignore_unused`
make ARCH=arm64 -j32
```
Find `Image` under `linux-xlnx/arch/arm64/boot/`.

## Build system.dtb - Device Tree Blob

```
git clone https://github.com/xilinx/device-tree-xlnx
# modify the device_tree_repo_path in gen-dts.tcl to the repo just cloned
hsi -nojournal -nolog -source gen-dtb.tcl -tclargs [path to hdf file]
cd build/dts
# edit system-top.dts to include the content of system.dts
# add the contents of two subsections below into system-top.dts
dtc -I dts -O dtb -o system.dtb system-top.dts
```
where hdf file is generated by `Export Hardware` in the previous step when building fsbl.elf.

### Set SD card as rootfs

```
/ {
  chosen {
    bootargs = "root=/dev/mmcblk0p2 rootfstype=ext4 rootwait earlycon clk_ignore_unused";
  };
};
```

### Add reserved memory

```
/ {
  reserved-memory {
    #address-cells = <2>;
    #size-cells = <2>;
    ranges;

    mem_reserved: buffer@800000000 {
      reg = <0x00000008 0x00000000 0x0 0x80000000>;
    };
	};
};
```

## Build rootfs in SD card

* New an `ext4` partition `mmcblk0p2` in SD card. Refer to the step of [here](https://wiki.debian.org/InstallingDebianOn/Xilinx/ZC702/wheezy#SD_Card_root) before executing `debootstrap`.
* download the debian base system to `mmcblk0p2` with `qemu-debootstrap`.
```
sudo qemu-debootstrap --arch arm64 stable /mnt http://ftp.debian.org/debian
sudo chroot /mnt /bin/bash
passwd
apt-get update
apt-get install openssh-server vim build-essential minicom tmux
exit
```
* Add a line of `ttyPS0` in `/mnt/etc/securetty` to allow login debian via `ttyPS0`. See [here](http://www.linuxquestions.org/questions/linux-newbie-8/login-incorrect-error-after-boot-no-password-prompted-881131/) for more details.
* Add a line of `PermitRootLogin yes` in `/mnt/etc/ssh/sshd_config` to enable root login via ssh. See [here](https://linuxconfig.org/enable-ssh-root-login-on-debian-linux-server) for more details.
* Add the following lines to `/mnt/etc/fstab`
```
# <file system> <mount point> <type>  <options> <dump>  <pass>
proc /proc proc defaults 0 0
/dev/mmcblk0p1 /boot vfat defaults 0 2
/dev/mmcblk0p2 / ext4 errors=remount-ro 0 1
```

Put `BOOT.BIN`, `Image` and `system.dtb` generated in the previous steps into `/dev/mmcblk0p1`.
Finally, insert the SD card into the board. It should be ready to boot debian.
