
# Preparing BOOT.BIN

Refer to www.wiki.xilinx.com/Fetch+Sources for more information.

## NOTICE

## Build fsbl.elf - First Step Boot Loader

1. Vivado -> File -> Export -> Export Hardware

Then run `hsi`
```
hsi -nojournal -nolog -source gen-fsbl.tcl -tclargs [path to hdf file]
```
where hdf file is generated by the previous step.

*Note:* fsbl.elf should be regenerated after the configuration of ZYNQ changes.

## Build u-boot

```
git clone https://github.com/xilinx/u-boot-xlnx
cd u-boot-xlnx
make zynq_zed_defconfig  # can be found under u-boot-xlnx/configs/
make CROSS_COMPILE=arm-linux-gnueabihf-
```
Find `u-boot.elf` under `u-boot-xlnx/`.

### Some useful build-in commands under u-boot

* `load mmc 0:auto <addr> <file>` - load `file` in SD card into memory `addr`
* `fatls mmc 0 <path>` - list files under `path` in SD card
* `fatwrite mmc 0 <addr> <file> <byte_in_hex>` - write `file` of size `byte_in_hex` from memory `addr` into SD card
* `fpga loadb 0 <addr> <byte_in_hex>` - download bitstream of size `byte_in_hex` from memory `addr`

### Some useful customized commands

* set IP address and TFTP server address
```
setenv ipaddr 10.30.6.61
setenv serverip 10.30.6.123
```

* download FPGA, get linux kernel image and DTB file by TFTP, then boot the kernel
```
"netboot=tftpboot 0x100000 fpga.bit && fpga loadb 0 $fileaddr $filesize && " \
"tftpboot $kernel_addr Image && tftpboot $fdt_addr system.dtb && booti $kernel_addr - $fdt_addr \0"
```

* download file by TFTP to the boot partition (`mmcblk0p1`) of SD card
```
// should set $filename first
"download_sd=tftpboot 0x100000 $filename && fatwrite mmc 0 $fileaddr $filename $filesize\0"
```

* update the boot partition (`mmcblk0p1`) of SD card (`BOOT.BIN` and `system.dtb`) by TFTP
```
"update_sdboot=setenv filename BOOT.BIN && run download_sd && " \
"setenv filename system.dtb && run download_sd\0"
```

## Build BOOT.BIN

1. Put `fsbl.elf` and `u-boot.elf` generated by previous steps under `build/` directory
1. (Optional) If you want to download the bitstream in fsbl, also put the bitstream under `build/` directory, and uncomment the description about bitstream in `gen-bootbin.sh`
1. run `bash gen-bootbin.sh`, `BOOT.BIN` will be generated under `build/`

## Build linux kernel

```
git clone https://github.com/xilinx/linux-xlnx
cd linux-xlnx
git checkout f1b1e077d641fc83b54c1b8f168cbb58044fbd4e  # this is the release version of 2017.03
make ARCH=arm64 xilinx_zynq_defconfig # can be found under linux-xlnx/arch/arm/configs/
make ARCH=arm64 menuconfig
  General setup -> Cross-compiler tool prefix: `arm-linux-gnueabihf-`
  General setup -> unchoose `Initial RAM filesystem and RAM disk (initramfs/initrd) support`
make ARCH=arm -j32
```
Find `Image` under `linux-xlnx/arch/arm/boot/`.

## Build system.dtb - Device Tree Blob

```
git clone https://github.com/xilinx/device-tree-xlnx
# modify the device_tree_repo_path in gen-dts.tcl to the repo just cloned
hsi -nojournal -nolog -source gen-dts.tcl -tclargs [path to hdf file]
cd build/dts
# edit system-top.dts to include the content of system.dts
dtc -I dts -O dtb -o system.dtb system-top.dts
```
where hdf file is generated by `Export Hardware` in the previous step building fsbl.elf.

### Set SD card as rootfs

```
/ {
  chosen {
    bootargs = "root=/dev/mmcblk0p2 rootfstype=ext4 rootwait earlycon clk_ignore_unused";
  };
};
```

### Add reserved memory

```
/ {
  reserved-memory {
    #address-cells = <1>;
    #size-cells = <1>;
    ranges;

    pard_reserved: buffer@100000000 {
      reg = <0x10000008 0x10000000>;
    };
	};
};
```

## Build rootfs in SD card

* New an `ext4` partition `mmcblk0p2` in SD card. Refer to the step of [here](https://wiki.debian.org/InstallingDebianOn/Xilinx/ZC702/wheezy#SD_Card_root) before executing `debootstrap`.
* download the debian base system to `mmcblk0p2` with `qemu-debootstrap`.
```
sudo qemu-debootstrap --arch arm stable /mnt http://ftp.debian.org/debian
sudo chroot /mnt /bin/bash
passwd
exit
```
* Add a line of `ttyPS0` in `/mnt/etc/securetty` to allow login debian via `ttyPS0`. See [here](http://www.linuxquestions.org/questions/linux-newbie-8/login-incorrect-error-after-boot-no-password-prompted-881131/) for more details.
* Add a line of `PermitRootLogin yes` in `/mnt/etc/ssh/sshd_config` to enable root login via ssh. See [here](https://linuxconfig.org/enable-ssh-root-login-on-debian-linux-server) for more details.
* Add the following lines to `/mnt/etc/fstab`
```
# <file system> <mount point> <type>  <options> <dump>  <pass>
proc /proc proc defaults 0 0
/dev/mmcblk0p1 /boot vfat defaults 0 2
/dev/mmcblk0p2 / ext4 errors=remount-ro 0 1
```

Finally, insert the SD card to the board. It should be ready to boot debian.
