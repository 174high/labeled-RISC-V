## Quick Start Guide

### Build RISC-V image

* Initialize all submodules and build riscv-tools according to the instructions of [README.md under the root directory of this repo](../README.md).
  * Please also install the linux-gnu toolchain
* Build riscv-pk (which contains bootloader) and riscv-linux with the following commands
```
mkdir build
make -j16 sw  # change 16 according to your host
```
If it is the first time you run this command, note that
1. You will be asked to pull the pk and linux repo under `../../sw`
1. A configuration menu will be popped up during initialization of linux repo. Choose `Exit`.
1. You will receive an error while creating ramdisk during building linux kernel. This is because we can not know your setting of `RISCV` environment variable in advance. You should modify library paths in `initramfs.txt` according to `RISCV`. After that, re-run the `make` command above.
```
cd path-to-riscv-linux/arch/riscv/rootfs
vim initramfs.txt # modify library paths to match your RISCV environment variable
```

After that, `linux.bin` will be generated under `build/`.

### Run with emulator

#### Build a minimal rootfs

```
cd path-to-riscv-linux
make ARCH=riscv menuconfig
# change `General setup` -> `Initramfs source file(s)` to `arch/riscv/rootfs/initramfs-emu.txt`
cd path-to-fpga
make -j16 sw
```
This will build a minimal rootfs only containing a `stream` program.

NOTE: To build a rootfs for FPGA, remember to change the initramfs source file back to `arch/riscv/rootfs/initramfs.txt`.

#### Build and run emulator

```
cd emulator    # NOTE: this is `fpga/emulator`, not the `emulator/` one
make -j16 run-emu
```
The following files will be generated
1. `emulator/build/test/generated-src/` is the directory containing files generated by origin rocketchip project
2. `emulator/build/test/emu.log` is the output of emulator, including `printf()` and `assert()` in scala code
3. `emulator/build/test/serial@6000?000` is the output of the ?th UART. Use `tail -f serial@60000000` to observe the output.

It may cost about one hour (it depends on the performance of your host) to boot linux in emulator. After `stream` exits, it can be considered as running emulator successfully.

### Run with FPGA

#### Build a Vivado project

* Install Vivado 2017.4, and source the setting of Vivado and SDK
* Run the following command to build a Vivado project
```
make project PRJ=myproject BOARD=zedboard
```
Change `zedboard` to the target board you want. Supported boards are listed under `board/`.
The project will be created under `build/myproject-zedboard`.
* Open the project with Vivado and generate bitstream.

#### Prepare SD card

Refer to the instructions of `board/your-target-board/boot/README.md` [(take zedboard as an example)](board/zedboard/boot/README.md).

NOTE: Remember to put the bitstream into BOOT.BIN, since the guide is going to boot everything from SD card.

#### Set your board to SD boot mode

Please refer to the user guide of your board.
* [zedboard](http://www.zedboard.org/sites/default/files/ZedBoard_HW_UG_v1_1.pdf)
* [zcu102](https://www.xilinx.com/support/documentation/boards_and_kits/zcu102/ug1182-zcu102-eval-bd.pdf)

#### Boot linux in PRM

NOTE: PRM is short for Platform Resource Manager, which is acted by PS part of the board.

* Insert the SD card into the board, open a serial terminal and powerup the board.
* Press any key to interrupt the default action in u-boot, and run the following commands to boot linux
```
load mmc 0:auto 0x3000000 Image
load mmc 0:auto 0x2a00000 system.dtb
booti 0x3000000 - 0x2a00000
```

#### Boot RISC-V subsystem

* Send the following files to PRM. This can be achieved by either copying the file to SD card, or by sending the file with `scp` if you have your board connected to your host by network.
  * `board/your-target-board/prm-loader/loader.c` [(take zedboard as an example)](board/zedboard/prm-loader/loader.c)
  * `board/your-target-board/prm-loader/configstr` [(take zedboard as an example)](board/zedboard/prm-loader/configstr)
  * `build/linux.bin`
* Compile the loader on PRM.
```
gcc -o loader loader.c
```
* Open minicom on PRM to connect to the UART of RISC-V subsystem. Note that you can connect to PRM via `ssh` and use `tmux` to get multiple terminals.
```
minicom -D /dev/ttyUL1
```
* Run loader to boot RISC-V subsystem.
```
./loader linux.bin configstr
```
It may cost about 100s for zedboard to boot the RISC-V subsystem. Most of the time is spent in unpacking ramdisk image.

### To Be Continued
